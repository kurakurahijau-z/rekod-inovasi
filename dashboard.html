/******************************************************
 * Rekod Inovasi Jabatan - Backend (Google Apps Script)
 * - Works with GitHub Pages frontend (CORS-safe approach)
 * - IMPORTANT: loginGoogle uses GET (no preflight)
 ******************************************************/

const SHEETS = {
  USERS: "Users",
  STAFF: "StaffDirectory",
  SESSIONS: "Sessions",
  INNOVATIONS: "Innovations",
  TEAM: "TeamMembers",
  COMPS: "Competitions",
};

function doGet(e) { return api_(e, "GET"); }
function doPost(e){ return api_(e, "POST"); }

function api_(e, method){
  try{
    const action = (e.parameter.action || "").trim();
    if (!action) return json_({ ok:false, error:"Missing action" });

    let body = {};
    if (method === "POST") {
      const raw = e.postData && e.postData.contents ? e.postData.contents : "";
      if (raw) { try { body = JSON.parse(raw); } catch(err){ body = {}; } }
    }

    switch(action){

      case "ping":
        return json_({ ok:true, ts:new Date().toISOString() });

      // ---- Google login (CORS-safe: GET)
      case "loginGoogle": {
        const credential = (e.parameter.credential || "").trim() || (body.credential || "");
        if (!credential) return json_({ ok:false, error:"Missing credential" });

        const payload = verifyGoogleIdToken_(credential);
        if (!payload.ok) return json_({ ok:false, error: payload.error || "Invalid Google token" });

        const email = String(payload.email || "").toLowerCase().trim();
        if (!email) return json_({ ok:false, error:"Email missing in token" });

        if (!existsInSheet_(SHEETS.STAFF, "email", email)) {
          return json_({ ok:false, error:"Email not in StaffDirectory whitelist" });
        }

        const role = getRole_(email); // admin/user
        ensureUserRow_(email, role);

        const token = createSession_(email);
        return json_({ ok:true, token, email, role });
      }

      case "me": {
        const token = (e.parameter.token || "").trim();
        const sess = getSession_(token);
        if (!sess.ok) return json_({ ok:false, error: sess.error || "Invalid session" });
        const role = getRole_(sess.email);
        touchSession_(token);
        return json_({ ok:true, email:sess.email, role });
      }

      case "listMyInnovations": {
        const token = (e.parameter.token || "").trim();
        const sess = getSession_(token);
        if (!sess.ok) return json_({ ok:false, error: sess.error });

        touchSession_(token);
        const items = listInnovationsByOwner_(sess.email);
        return json_({ ok:true, items });
      }

      case "addInnovation": {
        const token = (e.parameter.token || "").trim();
        const sess = getSession_(token);
        if (!sess.ok) return json_({ ok:false, error: sess.error });

        const p = body || {};
        const tajuk = String(p.tajuk||"").trim();
        const tahun = String(p.tahun||"").trim();
        const kategori = String(p.kategori||"").trim();
        const status = String(p.status||"").trim();
        const myipoStatus = String(p.myipoStatus||"").trim();
        const myipoNumber = String(p.myipoNumber||"").trim();

        if (!tajuk || !tahun) return json_({ ok:false, error:"Tajuk & tahun wajib isi" });

        const innovationId = uuid_();
        appendRow_(SHEETS.INNOVATIONS, [
          innovationId,
          tajuk,
          tahun,
          kategori,
          status,
          myipoStatus,
          myipoNumber,
          sess.email,
          new Date().toISOString(),
        ]);

        touchSession_(token);
        return json_({ ok:true, innovationId });
      }

      // ---- report (MY)
      case "generateReport": {
        const token = (e.parameter.token || "").trim();
        const year  = String(e.parameter.year || "").trim();
        const sess = getSession_(token);
        if (!sess.ok) return json_({ ok:false, error: sess.error });
        if (!year) return json_({ ok:false, error:"Missing year" });

        touchSession_(token);

        const all = listInnovationsByOwner_(sess.email)
          .filter(x => String(x.tahun||"").trim() === year);

        return json_({
          ok:true,
          year,
          items: all.map(x => ({
            tajuk: x.tajuk || "",
            kategori: x.kategori || "",
            status: x.status || "",
            myipoStatus: x.myipoStatus || "",
            myipoNumber: x.myipoNumber || "",
          }))
        });
      }

      // ---- report (DEPT) ADMIN ONLY
      case "generateDeptReport": {
        const token = (e.parameter.token || "").trim();
        const year  = String(e.parameter.year || "").trim();
        const sess = getSession_(token);
        if (!sess.ok) return json_({ ok:false, error: sess.error });
        if (!year) return json_({ ok:false, error:"Missing year" });

        const role = getRole_(sess.email);
        if (role !== "admin") return json_({ ok:false, error:"Forbidden (admin only)" });

        touchSession_(token);

        const all = listInnovationsAll_().filter(x => String(x.tahun||"").trim() === year);

        return json_({
          ok:true,
          year,
          items: all.map(x => ({
            ownerEmail: x.ownerEmail || "",
            tajuk: x.tajuk || "",
            kategori: x.kategori || "",
            status: x.status || "",
            myipoStatus: x.myipoStatus || "",
            myipoNumber: x.myipoNumber || "",
          }))
        });
      }

      default:
        return json_({ ok:false, error:`Unknown action: ${action}` });
    }

  } catch(err){
    return json_({ ok:false, error: String(err && err.message ? err.message : err) });
  }
}

/* =========================
   Helpers (Sheets)
========================= */

function ss_(){ return SpreadsheetApp.getActiveSpreadsheet(); }

function sheet_(name){
  const sh = ss_().getSheetByName(name);
  if (!sh) throw new Error(`Missing sheet: ${name}`);
  return sh;
}

function headers_(sh){
  const lastCol = Math.max(1, sh.getLastColumn());
  return sh.getRange(1,1,1,lastCol).getValues()[0].map(h => String(h||"").trim());
}

function colIndex_(sh, colName){
  const hs = headers_(sh);
  const idx = hs.indexOf(colName);
  if (idx === -1) throw new Error(`Missing column "${colName}" in sheet ${sh.getName()}`);
  return idx + 1;
}

function existsInSheet_(sheetName, colName, value){
  const sh = sheet_(sheetName);
  const col = colIndex_(sh, colName);
  const lastRow = sh.getLastRow();
  if (lastRow < 2) return false;
  const vals = sh.getRange(2,col,lastRow-1,1).getValues().flat().map(v => String(v||"").toLowerCase().trim());
  return vals.includes(String(value||"").toLowerCase().trim());
}

function findRowBy_(sheetName, colName, value){
  const sh = sheet_(sheetName);
  const col = colIndex_(sh, colName);
  const lastRow = sh.getLastRow();
  if (lastRow < 2) return 0;
  const vals = sh.getRange(2,col,lastRow-1,1).getValues().flat();
  const target = String(value||"").toLowerCase().trim();
  for (let i=0;i<vals.length;i++){
    if (String(vals[i]||"").toLowerCase().trim() === target) return i+2;
  }
  return 0;
}

function appendRow_(sheetName, arr){
  sheet_(sheetName).appendRow(arr);
}

/* =========================
   Users & Roles
========================= */

function getRole_(email){
  const sh = sheet_(SHEETS.USERS);
  const r = findRowBy_(SHEETS.USERS, "email", email);
  if (!r) return "user";
  const roleCol = colIndex_(sh, "role");
  const role = String(sh.getRange(r, roleCol).getValue() || "").trim();
  return role ? role : "user";
}

function ensureUserRow_(email, role){
  const sh = sheet_(SHEETS.USERS);
  const r = findRowBy_(SHEETS.USERS, "email", email);
  const roleCol  = colIndex_(sh, "role");
  const createdCol = colIndex_(sh, "createdAt");

  if (!r){
    sh.appendRow([ email, role || "user", new Date().toISOString() ]);
    return;
  }

  const existingRole = String(sh.getRange(r, roleCol).getValue() || "").trim();
  if (!existingRole && role) sh.getRange(r, roleCol).setValue(role);

  const ca = sh.getRange(r, createdCol).getValue();
  if (!ca) sh.getRange(r, createdCol).setValue(new Date().toISOString());
}

/* =========================
   Sessions
========================= */

function createSession_(email){
  const token = uuid_() + uuid_();
  appendRow_(SHEETS.SESSIONS, [ token, email, new Date().toISOString(), new Date().toISOString() ]);
  return token;
}

function getSession_(token){
  if (!token) return { ok:false, error:"Missing token" };
  const sh = sheet_(SHEETS.SESSIONS);
  const r = findRowBy_(SHEETS.SESSIONS, "token", token);
  if (!r) return { ok:false, error:"Session not found" };
  const emailCol = colIndex_(sh, "email");
  const email = String(sh.getRange(r, emailCol).getValue() || "").toLowerCase().trim();
  return { ok:true, email };
}

function touchSession_(token){
  const sh = sheet_(SHEETS.SESSIONS);
  const r = findRowBy_(SHEETS.SESSIONS, "token", token);
  if (!r) return;
  const lastSeenCol = colIndex_(sh, "lastSeenAt");
  sh.getRange(r, lastSeenCol).setValue(new Date().toISOString());
}

/* =========================
   Innovations
========================= */

function listInnovationsByOwner_(email){
  const sh = sheet_(SHEETS.INNOVATIONS);

  const hs = headers_(sh);
  const lastRow = sh.getLastRow();
  if (lastRow < 2) return [];

  const data = sh.getRange(2,1,lastRow-1,hs.length).getValues();
  const idx = (name) => hs.indexOf(name);

  const ownerIdx = idx("ownerEmail");
  return data
    .filter(row => String(row[ownerIdx]||"").toLowerCase().trim() === String(email||"").toLowerCase().trim())
    .map(row => ({
      innovationId: row[idx("innovationId")] || "",
      tajuk: row[idx("tajuk")] || "",
      tahun: row[idx("tahun")] || "",
      kategori: row[idx("kategori")] || "",
      status: row[idx("status")] || "",
      myipoStatus: row[idx("myipoStatus")] || "",
      myipoNumber: row[idx("myipoNumber")] || "",
      ownerEmail: row[ownerIdx] || "",
      createdAt: row[idx("createdAt")] || "",
    }));
}

function listInnovationsAll_(){
  const sh = sheet_(SHEETS.INNOVATIONS);
  const hs = headers_(sh);
  const lastRow = sh.getLastRow();
  if (lastRow < 2) return [];

  const data = sh.getRange(2,1,lastRow-1,hs.length).getValues();
  const idx = (name) => hs.indexOf(name);

  return data.map(row => ({
    innovationId: row[idx("innovationId")] || "",
    tajuk: row[idx("tajuk")] || "",
    tahun: row[idx("tahun")] || "",
    kategori: row[idx("kategori")] || "",
    status: row[idx("status")] || "",
    myipoStatus: row[idx("myipoStatus")] || "",
    myipoNumber: row[idx("myipoNumber")] || "",
    ownerEmail: row[idx("ownerEmail")] || "",
    createdAt: row[idx("createdAt")] || "",
  }));
}

/* =========================
   Google Token Verify (ID Token)
========================= */
function verifyGoogleIdToken_(idToken){
  try{
    const url = "https://oauth2.googleapis.com/tokeninfo?id_token=" + encodeURIComponent(idToken);
    const res = UrlFetchApp.fetch(url, { muteHttpExceptions:true });
    const code = res.getResponseCode();
    if (code !== 200) return { ok:false, error:"tokeninfo invalid" };

    const j = JSON.parse(res.getContentText());
    return { ok:true, email: j.email || "", hd: j.hd || "", aud: j.aud || "" };
  } catch(err){
    return { ok:false, error:"verify failed" };
  }
}

/* =========================
   Utils
========================= */
function json_(obj){
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function uuid_(){
  return Utilities.getUuid().replace(/-/g,"");
}
